<template>
  <Modal v-model="isOpen" title="거래 추가">
    <div class="add-transaction-form">
      <div class="form-row">
        <div class="form-group half">
          <label>시간</label>
          <div class="time-input-group">
            <input
              ref="hourInput"
              v-model="formData.hour"
              @input="handleHourInput"
              @focus="showHourDropdown"
              @blur="validateHour"
              type="text"
              class="time-input"
              placeholder="00"
              maxlength="2"
            />
            <span class="separator">:</span>
            <input
              ref="minuteInput"
              v-model="formData.minute"
              @input="handleMinuteInput"
              @focus="showMinuteDropdown"
              @blur="validateMinute"
              type="text"
              class="time-input"
              placeholder="00"
              maxlength="2"
            />
            <div v-if="isHourDropdownVisible" class="time-dropdown hour-dropdown">
              <div
                v-for="hour in hours"
                :key="hour"
                class="time-option"
                :class="{ selected: formData.hour === hour }"
                @mousedown.prevent="selectHour(hour)"
              >
                {{ hour }}
              </div>
            </div>
            <div v-if="isMinuteDropdownVisible" class="time-dropdown minute-dropdown">
              <div
                v-for="minute in minutes"
                :key="minute"
                class="time-option"
                :class="{ selected: formData.minute === minute }"
                @mousedown.prevent="selectMinute(minute)"
              >
                {{ minute }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group half">
          <label>타입</label>
          <div class="type-selector">
            <button
              @click="formData.type = 'income'"
              class="type-btn"
              :class="{ active: formData.type === 'income' }"
            >
              수입
            </button>
            <button
              @click="formData.type = 'expense'"
              class="type-btn"
              :class="{ active: formData.type === 'expense' }"
            >
              지출
            </button>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label>계좌</label>
        <div class="custom-select" :class="{ open: isAccountOpen }" @click="toggleAccount">
          <div class="select-trigger">
            <span :class="{ placeholder: !formData.accountId }">
              {{ selectedAccountName || '계좌를 선택하세요' }}
            </span>
            <span class="arrow">▼</span>
          </div>
          <div class="select-options" v-if="isAccountOpen">
            <div
              v-for="account in accounts"
              :key="account.id"
              class="option"
              :class="{ selected: formData.accountId === account.id }"
              @click.stop="selectAccount(account.id)"
            >
              {{ account.bankName }} ({{ formatAccountNumber(account.accountNumber) }})
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label>카테고리</label>
        <div class="custom-select" :class="{ open: isCategoryOpen }" @click="toggleCategory">
          <div class="select-trigger">
            <span :class="{ placeholder: !formData.category }">
              {{ formData.category || '카테고리를 선택하세요' }}
            </span>
            <span class="arrow">▼</span>
          </div>
          <div class="select-options" v-if="isCategoryOpen">
            <div
              v-for="category in categories"
              :key="category"
              class="option"
              :class="{ selected: formData.category === category }"
              @click.stop="selectCategory(category)"
            >
              {{ category }}
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label>금액</label>
        <input
          v-model="displayAmount"
          @input="handleAmountInput"
          type="text"
          class="form-input amount-input"
          placeholder="금액을 입력하세요"
        />
      </div>
      
      <div class="form-group">
        <label>상세내역</label>
        <textarea
          v-model="formData.description"
          class="form-textarea"
          placeholder="상세내역을 입력하세요 (선택)"
          rows="3"
        ></textarea>
      </div>
    </div>
    
    <template #footer>
      <button @click="handleCancel" class="btn btn-cancel">취소</button>
      <button @click="handleSubmit" class="btn btn-submit" :disabled="!isFormValid">등록</button>
    </template>
  </Modal>
</template>

<script setup lang="ts">
import { ref, watch, computed } from 'vue'
import Modal from '@/components/common/Modal.vue'
import { useAccountsStore } from '@/stores/accounts'

interface Props {
  modelValue: boolean
  date: Date | null
}

const props = defineProps<Props>()

const emit = defineEmits<{
  'update:modelValue': [value: boolean]
  'submit': [data: {
    accountId: string
    date: string
    time: string
    type: 'income' | 'expense'
    category: string
    amount: number
    description: string
  }]
}>()

const accountsStore = useAccountsStore()

const isOpen = ref(props.modelValue)
const isCategoryOpen = ref(false)
const isAccountOpen = ref(false)
const isHourDropdownVisible = ref(false)
const isMinuteDropdownVisible = ref(false)

const hourInput = ref<HTMLInputElement | null>(null)
const minuteInput = ref<HTMLInputElement | null>(null)

watch(() => props.modelValue, (newValue) => {
  isOpen.value = newValue
  if (!newValue) {
    isCategoryOpen.value = false
    isAccountOpen.value = false
    isHourDropdownVisible.value = false
    isMinuteDropdownVisible.value = false
  }
})

watch(isOpen, (newValue) => {
  emit('update:modelValue', newValue)
})

const formData = ref({
  accountId: '',
  hour: '12',
  minute: '00',
  type: 'expense' as 'income' | 'expense',
  category: '',
  amount: 0,
  description: ''
})

const displayAmount = ref('')

const hours = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0'))
const minutes = Array.from({ length: 60 }, (_, i) => String(i).padStart(2, '0'))

const handleHourInput = (e: Event) => {
  const input = e.target as HTMLInputElement
  let value = input.value.replace(/\D/g, '')
  
  if (value.length > 0) {
    const numValue = parseInt(value)
    if (numValue > 23) {
      value = '23'
    }
  }
  
  if (value.length <= 2) {
    formData.value.hour = value
  }
}

const handleMinuteInput = (e: Event) => {
  const input = e.target as HTMLInputElement
  let value = input.value.replace(/\D/g, '')
  
  if (value.length > 0) {
    const numValue = parseInt(value)
    if (numValue > 59) {
      value = '59'
    }
  }
  
  if (value.length <= 2) {
    formData.value.minute = value
  }
}

const showHourDropdown = () => {
  isHourDropdownVisible.value = true
  isMinuteDropdownVisible.value = false
}

const hideHourDropdown = () => {
  setTimeout(() => {
    isHourDropdownVisible.value = false
  }, 200)
}

const showMinuteDropdown = () => {
  isMinuteDropdownVisible.value = true
  isHourDropdownVisible.value = false
}

const hideMinuteDropdown = () => {
  setTimeout(() => {
    isMinuteDropdownVisible.value = false
  }, 200)
}

const validateHour = () => {
  if (formData.value.hour) {
    formData.value.hour = formData.value.hour.padStart(2, '0')
  }
  hideHourDropdown()
}

const validateMinute = () => {
  if (formData.value.minute) {
    formData.value.minute = formData.value.minute.padStart(2, '0')
  }
  hideMinuteDropdown()
}

const selectHour = (hour: string) => {
  formData.value.hour = hour
  isHourDropdownVisible.value = false
  minuteInput.value?.focus()
}

const selectMinute = (minute: string) => {
  formData.value.minute = minute
  isMinuteDropdownVisible.value = false
}

const handleAmountInput = (e: Event) => {
  const input = e.target as HTMLInputElement
  const value = input.value.replace(/,/g, '')
  
  if (value === '' || /^\d+$/.test(value)) {
    const numValue = value === '' ? 0 : parseInt(value)
    formData.value.amount = numValue
    displayAmount.value = numValue === 0 ? '' : numValue.toLocaleString()
  } else {
    input.value = displayAmount.value
  }
}

const accounts = computed(() => accountsStore.accounts)

const selectedAccountName = computed(() => {
  const account = accounts.value.find(a => a.id === formData.value.accountId)
  return account ? `${account.bankName} (${formatAccountNumber(account.accountNumber)})` : ''
})

const categories = [
  '급여',
  '부수입',
  '식비',
  '교통',
  '쇼핑',
  '의료',
  '문화',
  '여행',
  '교육',
  '기타'
]

const isFormValid = computed(() => {
  return formData.value.accountId !== '' && formData.value.category !== '' && formData.value.amount > 0
})

const formatAccountNumber = (accountNumber: string | undefined) => {
  if (!accountNumber || accountNumber === '정보 없음') return '****'
  if (accountNumber.length > 4) {
    return '****' + accountNumber.slice(-4)
  }
  return accountNumber
}

const toggleCategory = () => {
  isCategoryOpen.value = !isCategoryOpen.value
  isAccountOpen.value = false
}

const selectCategory = (category: string) => {
  formData.value.category = category
  isCategoryOpen.value = false
}

const toggleAccount = () => {
  isAccountOpen.value = !isAccountOpen.value
  isCategoryOpen.value = false
}

const selectAccount = (accountId: string) => {
  formData.value.accountId = accountId
  isAccountOpen.value = false
}

const handleCancel = () => {
  isOpen.value = false
  resetForm()
}

const handleSubmit = () => {
  if (!isFormValid.value) {
    return
  }
  
  if (!props.date) {
    return
  }
  
  const year = props.date.getFullYear()
  const month = String(props.date.getMonth() + 1).padStart(2, '0')
  const day = String(props.date.getDate()).padStart(2, '0')
  const dateStr = `${year}-${month}-${day}`
  
  emit('submit', {
    accountId: formData.value.accountId,
    date: dateStr,
    time: `${formData.value.hour}:${formData.value.minute}:00`,
    type: formData.value.type,
    category: formData.value.category,
    amount: Number(formData.value.amount),
    description: formData.value.description
  })
  
  resetForm()
  isOpen.value = false
}

const resetForm = () => {
  formData.value = {
    accountId: '',
    hour: '12',
    minute: '00',
    type: 'expense',
    category: '',
    amount: 0,
    description: ''
  }
  displayAmount.value = ''
}
</script>

<style lang="scss" scoped>
.add-transaction-form {
  display: flex;
  flex-direction: column;
  gap: $spacing-lg;
}

.form-row {
  display: flex;
  gap: $spacing-md;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: $spacing-sm;
  
  &.half {
    flex: 1;
  }
  
  label {
    font-size: 14px;
    font-weight: 600;
    color: $color-text;
  }
  
  .form-input,
  .form-textarea {
    padding: $spacing-md;
    border: 1px solid #CCC;
    border-radius: $border-radius;
    font-size: 14px;
    color: $color-text;
    transition: all $transition-speed;
    font-family: inherit;
    
    &:focus {
      outline: none;
      border-color: $color-sub;
    }
  }
  
  .amount-input {
    text-align: right;
  }
  
  .form-textarea {
    resize: none;
    overflow: hidden;
  }
}

.time-input-group {
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
  
  .time-input {
    width: 70px;
    padding: $spacing-md;
    border: 1px solid #CCC;
    border-radius: $border-radius;
    font-size: 14px;
    color: $color-text;
    text-align: center;
    transition: all $transition-speed;
    
    &:focus {
      outline: none;
      border-color: $color-sub;
    }
  }
  
  .separator {
    font-size: 18px;
    font-weight: 600;
    color: $color-text;
  }
  
  .time-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    background: white;
    border: 1px solid #CCC;
    border-radius: $border-radius;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    width: 60px;
    
    &.hour-dropdown {
      left: 0;
    }
    
    &.minute-dropdown {
      left: 66px;
    }
    
    .time-option {
      padding: 8px 12px;
      font-size: 14px;
      color: $color-text;
      cursor: pointer;
      text-align: center;
      transition: background $transition-speed;
      
      &:hover {
        background: rgba($color-sub, 0.1);
      }
      
      &.selected {
        background: rgba($color-sub, 0.2);
        font-weight: 600;
      }
    }
  }
}

.type-selector {
  display: flex;
  gap: $spacing-sm;
  
  .type-btn {
    flex: 1;
    padding: $spacing-md;
    border: 1px solid #CCC;
    border-radius: $border-radius;
    background: white;
    color: $color-text;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all $transition-speed;
    
    &:hover {
      background: rgba($color-sub, 0.05);
    }
    
    &.active {
      background: $color-sub;
      color: white;
      border-color: $color-sub;
    }
  }
}

.custom-select {
  position: relative;
  
  .select-trigger {
    padding: $spacing-md;
    border: 1px solid #CCC;
    border-radius: $border-radius;
    font-size: 14px;
    color: $color-text;
    background: white;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all $transition-speed;
    
    .placeholder {
      color: rgba($color-text, 0.4);
    }
    
    .arrow {
      font-size: 10px;
      transition: transform $transition-speed;
      color: rgba($color-text, 0.5);
    }
  }
  
  &.open .select-trigger {
    border-color: $color-sub;
    
    .arrow {
      transform: rotate(180deg);
    }
  }
  
  .select-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 4px;
    background: white;
    border: 1px solid #CCC;
    border-radius: $border-radius;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    
    .option {
      padding: $spacing-sm $spacing-md;
      font-size: 14px;
      color: $color-text;
      cursor: pointer;
      transition: background $transition-speed;
      
      &:hover {
        background: rgba($color-sub, 0.1);
      }
      
      &.selected {
        background: rgba($color-sub, 0.2);
        font-weight: 600;
      }
    }
  }
}

.btn {
  padding: $spacing-sm $spacing-lg;
  border: none;
  border-radius: $border-radius;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all $transition-speed;
  
  &.btn-cancel {
    background: #F5F5F5;
    color: $color-text;
    
    &:hover {
      background: #E0E0E0;
    }
  }
  
  &.btn-submit {
    background: $color-sub;
    color: white;
    
    &:hover:not(:disabled) {
      opacity: 0.9;
    }
    
    &:disabled {
      background: rgba($color-sub, 0.4);
      cursor: not-allowed;
      opacity: 0.6;
    }
  }
}
</style>
