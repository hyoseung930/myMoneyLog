generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                            String        @id @default(uuid()) @db.VarChar(36)
  username                      String        @unique @db.VarChar(100)
  nickname                      String        @db.VarChar(100)
  password                      String        @db.VarChar(255)
  encryptedMasterKeyByPassword  String?       @map("encrypted_master_key_by_password") @db.Text
  passwordSalt                  String?       @map("password_salt") @db.Text
  encryptedMasterKeyByRecovery  String?       @map("encrypted_master_key_by_recovery") @db.Text
  recoverySalt                  String?       @map("recovery_salt") @db.Text
  createdAt                     DateTime      @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt                     DateTime      @updatedAt @map("updated_at") @db.Timestamp(0)
  
  accounts             Account[]
  transactions         Transaction[]

  @@map("users")
}

model Account {
  id                        String        @id @default(uuid()) @db.VarChar(36)
  userId                    String        @map("user_id") @db.VarChar(36)
  bankName                  String        @map("bank_name") @db.VarChar(100)
  encryptedAccountNumber    String        @map("encrypted_account_number") @db.Text
  accountNumberIv           String        @map("account_number_iv") @db.VarChar(100)
  accountType               String        @map("account_type") @db.VarChar(50)
  balance                   Decimal       @default(0) @db.Decimal(15, 2)
  createdAt                 DateTime      @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt                 DateTime      @updatedAt @map("updated_at") @db.Timestamp(0)
  
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([userId])
  @@map("accounts")
}

model Transaction {
  id                    String   @id @default(uuid()) @db.VarChar(36)
  userId                String   @map("user_id") @db.VarChar(36)
  accountId             String   @map("account_id") @db.VarChar(36)
  date                  DateTime @db.Date
  time                  String?  @map("time") @db.VarChar(10)
  amount                Decimal  @db.Decimal(15, 2)
  type                  TransactionType
  category              String   @db.VarChar(100)
  description           String?  @db.Text
  encryptedDescription  String?  @map("encrypted_description") @db.Text
  descriptionIv         String?  @map("description_iv") @db.VarChar(100)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamp(0)
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([accountId])
  @@map("transactions")
}

enum TransactionType {
  income
  expense
}
